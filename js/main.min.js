(function(a){a.fn.wScratchPad=function(e,d){if(typeof e==="object"){d=e}else{if(typeof e=="string"){var c=[];var f=this.each(function(){var g=a(this).data("_wScratchPad");if(g){if(e==="reset"){g.reset()}else{if(e==="clear"){g.clear()}else{if(e==="enabled"){g.enabled=d===true}else{if(a.fn.wScratchPad.defaultSettings[e]!==undefined){if(d!==undefined){g.settings[e]=d}else{c.push(g.settings[e])}}}}}}});if(c.length===1){return c[0]}if(c.length>0){return c}else{return f}}}d=a.extend({},a.fn.wScratchPad.defaultSettings,d||{});return this.each(function(){var h=a(this);var g=jQuery.extend(true,{},d);var j=document.createElement("canvas");if(!j.getContext){h.html("Browser does not support HTML5 canvas, please upgrade to a more modern browser.");return false}var i=new b(g,h);h.append(i.generate());i.pixels=i.canvas.width*i.canvas.height;h.data("_wScratchPad",i);i.init()})};a.fn.wScratchPad.defaultSettings={width:209,height:316,image:"images/slide1.jpg",image2:null,color:"",overlay:"none",size:20,realtimePercent:true,scratchDown:null,scratchUp:null,scratchMove:null,cursor:null};function b(c,d){this.sp=null;this.settings=c;this.$elem=d;this.enabled=true;this.scratch=false;this.canvas=null;this.ctx=null;return this}b.prototype={generate:function(){var c=this;this.canvas=document.createElement("canvas");this.ctx=this.canvas.getContext("2d");this.sp=a(this.canvas).attr("width",this.settings.width+"px").attr("height",this.settings.height+"px").attr("id","canvas").attr("class","gua_canvas");a(this.canvas).mousedown(function(d){if(!c.enabled){return true}d.preventDefault();d.stopPropagation();c.canvas_offset=a(c.canvas).offset();c.scratch=true;c.scratchFunc(d,c,"Down")}).mousemove(function(d){d.preventDefault();d.stopPropagation();if(c.scratch){c.scratchFunc(d,c,"Move")}}).mouseup(function(d){d.preventDefault();d.stopPropagation();if(c.scratch){c.scratch=false;c.scratchFunc(d,c,"Up")}});this.bindMobile(this.sp);return this.sp},bindMobile:function(c){c.bind("touchstart touchmove touchend touchcancel",function(){var f=event.changedTouches,g=f[0],d="";switch(event.type){case"touchstart":d="mousedown";break;case"touchmove":d="mousemove";break;case"touchend":d="mouseup";break;default:return}var e=document.createEvent("MouseEvent");e.initMouseEvent(d,true,true,window,1,g.screenX,g.screenY,g.clientX,g.clientY,false,false,false,false,0,null);g.target.dispatchEvent(e);event.preventDefault()})},init:function(){this.sp.css("cursor",(this.settings.cursor?'url("'+this.settings.cursor+'"), default':"default"));a(this.canvas).css({cursor:(this.settings.cursor?'url("'+this.settings.cursor+'"), default':"default")});this.canvas.width=this.settings.width;this.canvas.height=this.settings.height;this.pixels=this.canvas.width*this.canvas.height;if(this.settings.image2){this.drawImage(this.settings.image2)}else{if(this.settings.overlay!="none"){if(this.settings.image){this.drawImage(this.settings.image)}this.ctx.globalCompositeOperation=this.settings.overlay}else{this.setBgImage()}this.ctx.fillStyle=this.settings.color;this.ctx.beginPath();this.ctx.rect(0,0,this.settings.width,this.settings.height);this.ctx.fill()}},reset:function(){this.ctx.globalCompositeOperation="source-over";this.init()},clear:function(){this.ctx.clearRect(0,0,this.settings.width,this.settings.height)},setBgImage:function(){if(this.settings.image){this.sp.css({backgroundImage:"url("+this.settings.image+")"})}},drawImage:function(c){var e=this;var d=new Image();d.src=c;a(d).load(function(){e.ctx.drawImage(d,0,0);e.setBgImage()})},scratchFunc:function(f,d,c){f.pageX=Math.floor(f.pageX-d.canvas_offset.left);f.pageY=Math.floor(f.pageY-d.canvas_offset.top);d["scratch"+c](f,d);if(this.settings.realtimePercent||c=="Up"){if(d.settings["scratch"+c]){d.settings["scratch"+c].apply(d,[f,d.scratchPercentage(d)])}}},scratchPercentage:function(f){var c=0;var g=f.ctx.getImageData(0,0,f.canvas.width,f.canvas.height);for(var d=0,e=g.data.length;d<e;d=d+4){if(g.data[d]==0&&g.data[d+1]==0&&g.data[d+2]==0&&g.data[d+3]==0){c++}}return(c/f.pixels)*100},scratchDown:function(d,c){c.ctx.globalCompositeOperation="destination-out";c.ctx.lineJoin="round";c.ctx.lineCap="round";c.ctx.strokeStyle=c.settings.color;c.ctx.lineWidth=c.settings.size;c.ctx.beginPath();c.ctx.arc(d.pageX+4,d.pageY+4,c.settings.size,0,Math.PI*2,true);c.ctx.closePath();c.ctx.fill();c.ctx.beginPath();c.ctx.moveTo(d.pageX,d.pageY)},scratchMove:function(d,c){c.ctx.lineTo(d.pageX+4,d.pageY+4,c.settings.size);c.ctx.stroke()},scratchUp:function(d,c){c.ctx.closePath()}}})(jQuery);